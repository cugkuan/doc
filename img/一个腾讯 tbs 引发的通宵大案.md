
#   概述

腾讯的tbs 抹平了Android 版本机型差异，给h5的适配减少成吨的工作量，但是问题也不少。

测试发现，前端同事的手机进入某个页面后，不停的闪烁，退出来重新进入就没问题了；而且这个情况只发现在首次安装APP，或者清理完数据后才出现。前端来找同事解决，同事认为该问题是前端的问题，不了了之。

在发版的前一晚上问题爆发了！

# 问题定位

 通过定位，发现了一个极其诡异的问题，那就是设置的cookie 中，丢失了token，导致前端拿不到 token，认为用户没有登录，然后通过 js桥接；吊起我们的登录界面，登录成功后，cookie并没有设置进去。前端的回调拿不到 token，然后又调起登录，陷入死循环，对外的表现就是界面闪烁....


# 解决
 
  当时还在做其它的事情,稀里糊涂就听从了同事的建议，在每次获取cookie 的时候，先清理 cookie,在重新的设置于是

  ```
    val cookieManager = CookieManager.getInstance()
    cookieManager.setAcceptCookie(true)
    cookieManager.removeAllCookies {
        // 重新的设置cookie
        
        }
  ```
  
  改为之后，测试可以了，也就没管了。

  
  当凌晨2打完正式包，下班后，凌晨三点多，h5那边炸锅了，他们说，登录之后，没有回调了。

  凌晨四点，回到公司，通过定位，发现了问题所在。


**每次获取cookie就先清理再设置，且不说这种效率很低， CookieManager.removeAllCookies 带回调参数的是异步的，且只有腾讯的tbs 有这个方法**

这个方法是异步的，后面导致了一系列的问题。

定位到问题解决的方式也简单了。

-  在登录成功后异步更新 cookie,更新之后在发出登录成功的通知。
-  在h5调用登录的时候，如果是处于已经登录的状态，证明cookie 中没有 token，先清除cookie,再重新设置，设置成功后，回调给h5



# 总结

不放过任何一个微小的错误，一个微小的错误，最终导致更大的问题，因为同事没有深入了解问题的本质，简单的把问题归结给h5的问题。

仔细的了解方法是同步的还是异步的，对于异步的方法，一定要多考虑。